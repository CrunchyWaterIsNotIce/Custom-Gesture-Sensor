#include <Arduino.h>
#include <Wire.h>
#include <SparkFun_APDS9960.h>

#include <Custom_Gesture_Sensor_inferencing.h>

SparkFun_APDS9960 apds = SparkFun_APDS9960();

#define SDA_PIN 21
#define SCL_PIN 22


const int RECORD_SECONDS = 2000; // ms
const int RECORD_DELAY = 50; // ms
const int NUM_SAMPLES = RECORD_SECONDS / RECORD_DELAY;

void setup() {
  Serial.begin(115200);
  delay(100);

  // at 100 k
  Wire.begin(SDA_PIN, SCL_PIN, 100000);
  Wire.setTimeout(2500); // increase timeout to avoid error 263

  Serial.println("Initializing apds9960...");

  if (apds.init()) {
    Serial.println("Initialized!");
  } else {
    Serial.println("Fail to initialize apds9960.");
    while (1);
  }
  apds.enableProximitySensor(true);
  apds.enableLightSensor(true);
  // Prompts custom gesture
  Serial.println("Enter gesture and press enter:");
}

void loop() {
  if (Serial.available() > 0) {
    // Read User Input
    String gesture_input = Serial.readString();
    gesture_input.trim();
    if (gesture_input.length() == 0 || gesture_input.indexOf('~') == -1) {
      while(Serial.available() > 0) Serial.read();
      return; // Exit and wait for more input
    }

    Serial.println(gesture_input);

    Serial.printf("Now recording gesture, %s, for 2 seconds: \n", gesture_input);
    Serial.println("Get ready...");

    // Countdown
    for(int countdown = 5; countdown > 0; countdown--) {
      Serial.printf("%d...\n", countdown);
      delay(1000);
    }
    Serial.println("GO");
    delay(1000);

    Serial.println();
    Serial.println("proximity,r,g,b");
    for (int i = 0; i < NUM_SAMPLES; i++) {
      uint8_t proximity = 0;
      uint16_t r = 0, g = 0, b = 0;
      apds.readProximity(proximity);
      apds.readRedLight(r);
      apds.readGreenLight(g);
      apds.readBlueLight(b);
      Serial.printf("%d,%d,%d,%d\n", proximity, r, g, b);
      delay(RECORD_DELAY);
    }
    Serial.println();
    Serial.println("Waiting for next gesture to record: ");
  }
}
